// ==========================================================================
// Content Generator Module - ÎèôÏ†Å ÏΩòÌÖêÏ∏† ÏÉùÏÑ± Î∞è ÎÇ¥Î≥¥ÎÇ¥Í∏∞
// ==========================================================================

export class ContentGenerator {
    constructor() {
        this.sections = [];
        this.projectData = {};
        this.personalInfo = {};
        
        this.init();
    }

    /**
     * Ï¥àÍ∏∞Ìôî
     */
    init() {
        this.loadContentData();
        this.setupExportButtons();
    }

    /**
     * ÌòÑÏû¨ ÏΩòÌÖêÏ∏† Îç∞Ïù¥ÌÑ∞ Î°úÎìú
     */
    async loadContentData() {
        try {
            // ÏÑπÏÖò Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            if (window.SectionLoader && window.SectionLoader.sectionsData) {
                this.sections = window.SectionLoader.sectionsData.sections || [];
            } else {
                // JSON ÌååÏùºÏóêÏÑú ÏßÅÏ†ë Î°úÎìú
                const response = await fetch('data/sections-data.json');
                const data = await response.json();
                this.sections = data.sections || [];
            }

            // Í∞úÏù∏ Ï†ïÎ≥¥ Ï∂îÏ∂ú
            this.extractPersonalInfo();
            
            console.log('üìÑ Content data loaded:', this.sections.length, 'sections');
        } catch (error) {
            console.error('Failed to load content data:', error);
            this.loadFallbackContent();
        }
    }

    /**
     * Í∞úÏù∏ Ï†ïÎ≥¥ Ï∂îÏ∂ú
     */
    extractPersonalInfo() {
        // HTMLÏóêÏÑú Í∞úÏù∏ Ï†ïÎ≥¥ Ï∂îÏ∂ú
        const nameElement = document.querySelector('.name');
        const titleElement = document.querySelector('.title');
        const contactElements = document.querySelectorAll('.contact-item');

        this.personalInfo = {
            name: nameElement ? nameElement.textContent.trim() : 'ÍπÄÍ≤ΩÌïú',
            title: titleElement ? titleElement.textContent.trim() : 'GAME DEVELOPER',
            contacts: Array.from(contactElements).map(el => ({
                type: this.getContactType(el.textContent),
                value: el.textContent.trim(),
                href: el.getAttribute('href')
            }))
        };

        // Í≤ΩÎ†• Ï†ïÎ≥¥ Ï∂îÍ∞Ä
        if (window.CareerManager) {
            this.personalInfo.experience = window.CareerManager.getExperienceData();
            this.personalInfo.level = window.CareerManager.getCurrentLevel();
        }
    }

    /**
     * Ïó∞ÎùΩÏ≤ò ÌÉÄÏûÖ Í∞êÏßÄ
     * @param {string} text - Ïó∞ÎùΩÏ≤ò ÌÖçÏä§Ìä∏
     * @returns {string} Ïó∞ÎùΩÏ≤ò ÌÉÄÏûÖ
     */
    getContactType(text) {
        if (text.includes('@')) return 'email';
        if (text.includes('010') || text.includes('tel:')) return 'phone';
        if (text.includes('github')) return 'github';
        if (text.includes('linkedin')) return 'linkedin';
        return 'other';
    }

    /**
     * Ìè¥Î∞± ÏΩòÌÖêÏ∏† Î°úÎìú
     */
    loadFallbackContent() {
        this.sections = [
            {
                type: 'basic',
                title: 'PLAYER PROFILE',
                content: 'üéÆ Í≤åÏûÑ Í∞úÎ∞úÏûê ‚Ä¢ 5ÎÖÑ Í≤ΩÎ†• ‚Ä¢ Unity & Unreal Engine Ï†ÑÎ¨∏Í∞Ä'
            }
        ];
        
        this.personalInfo = {
            name: 'ÍπÄÍ≤ΩÌïú',
            title: 'GAME DEVELOPER',
            contacts: []
        };
        
        console.warn('Using fallback content data');
    }

    /**
     * Word Î¨∏ÏÑúÏö© ÏΩòÌÖêÏ∏† ÏÉùÏÑ±
     * @returns {string} Word Î¨∏ÏÑú HTML ÏΩòÌÖêÏ∏†
     */
    generateWordContent() {
        const sections = this.sections.map(section => this.formatSectionForWord(section)).join('\n\n');
        
        const wordContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${this.personalInfo.name} - Ïù¥Î†•ÏÑú</title>
    <style>
        body { 
            font-family: 'Malgun Gothic', sans-serif; 
            line-height: 1.6; 
            color: #333; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        .header { 
            text-align: center; 
            border-bottom: 2px solid #1976D2; 
            padding-bottom: 20px; 
            margin-bottom: 30px; 
        }
        .name { 
            font-size: 28px; 
            font-weight: bold; 
            color: #1976D2; 
            margin-bottom: 10px; 
        }
        .title { 
            font-size: 16px; 
            color: #666; 
            margin-bottom: 15px; 
        }
        .contact-info { 
            font-size: 14px; 
            color: #555; 
        }
        .section { 
            margin-bottom: 25px; 
            page-break-inside: avoid; 
        }
        .section-title { 
            font-size: 18px; 
            font-weight: bold; 
            color: #1976D2; 
            border-bottom: 1px solid #ccc; 
            padding-bottom: 5px; 
            margin-bottom: 15px; 
        }
        .project-card { 
            margin-bottom: 20px; 
            padding: 15px; 
            border: 1px solid #e0e0e0; 
            border-radius: 5px; 
        }
        .project-title { 
            font-size: 16px; 
            font-weight: bold; 
            color: #333; 
            margin-bottom: 10px; 
        }
        .tech-tags { 
            margin-top: 10px; 
        }
        .tech-tag { 
            display: inline-block; 
            background: #f5f5f5; 
            padding: 3px 8px; 
            border-radius: 3px; 
            font-size: 12px; 
            margin-right: 5px; 
            margin-bottom: 5px; 
        }
        ul { 
            margin: 10px 0; 
            padding-left: 20px; 
        }
        li { 
            margin-bottom: 5px; 
        }
        .performance-stats { 
            display: none; 
        }
        .architecture-diagram { 
            font-family: monospace; 
            font-size: 11px; 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 3px; 
            white-space: pre; 
            overflow-x: auto; 
        }
        .code-snippet { 
            font-family: monospace; 
            font-size: 11px; 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 3px; 
            white-space: pre-wrap; 
        }
        .media-gallery { 
            display: none; 
        }
        @media print {
            body { margin: 0; padding: 10px; }
            .section { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="name">${this.personalInfo.name}</div>
        <div class="title">${this.cleanTitle(this.personalInfo.title)}</div>
        <div class="contact-info">
            ${this.formatContactsForWord()}
        </div>
        ${this.generateCareerSummary()}
    </div>
    
    ${sections}
    
    <div class="section">
        <div class="section-title">Î¨∏ÏÑú ÏÉùÏÑ± Ï†ïÎ≥¥</div>
        <p>ÏÉùÏÑ±Ïùº: ${new Date().toLocaleDateString('ko-KR')}</p>
        <p>ÏÉùÏÑ± ÏãúÍ∞Ñ: ${new Date().toLocaleTimeString('ko-KR')}</p>
        <p>ÏÑπÏÖò Ïàò: ${this.sections.length}Í∞ú</p>
    </div>
</body>
</html>
        `.trim();

        return wordContent;
    }

    /**
     * ÏÑπÏÖòÏùÑ Word ÌòïÏãùÏúºÎ°ú Ìè¨Îß∑
     * @param {Object} section - ÏÑπÏÖò Îç∞Ïù¥ÌÑ∞
     * @returns {string} Ìè¨Îß∑Îêú HTML
     */
    formatSectionForWord(section) {
        let content = '';
        
        switch (section.type) {
            case 'basic':
                content = this.formatBasicSection(section);
                break;
            case 'project':
                content = this.formatProjectSection(section);
                break;
            case 'skills':
                content = this.formatSkillsSection(section);
                break;
            case 'code':
                content = this.formatCodeSection(section);
                break;
            default:
                content = this.formatBasicSection(section);
        }

        return `
            <div class="section">
                <div class="section-title">${section.title}</div>
                ${content}
            </div>
        `;
    }

    /**
     * Í∏∞Î≥∏ ÏÑπÏÖò Ìè¨Îß∑
     * @param {Object} section - ÏÑπÏÖò Îç∞Ïù¥ÌÑ∞
     * @returns {string} Ìè¨Îß∑Îêú HTML
     */
    formatBasicSection(section) {
        const content = Array.isArray(section.content) 
            ? section.content.join('') 
            : section.content;
        
        return this.cleanHTMLForWord(content);
    }

    /**
     * ÌîÑÎ°úÏ†ùÌä∏ ÏÑπÏÖò Ìè¨Îß∑
     * @param {Object} section - ÏÑπÏÖò Îç∞Ïù¥ÌÑ∞
     * @returns {string} Ìè¨Îß∑Îêú HTML
     */
    formatProjectSection(section) {
        const description = Array.isArray(section.description) 
            ? section.description.join('') 
            : section.description;

        const meta = section.meta ? section.meta.join(' ‚Ä¢ ') : '';
        const techTags = section.techTags ? 
            section.techTags.map(tech => `<span class="tech-tag">${tech.name}</span>`).join('') : '';

        return `
            <div class="project-card">
                <div class="project-title">${section.title}</div>
                ${meta ? `<div style="color: #666; margin-bottom: 10px;">${meta}</div>` : ''}
                <div>${this.cleanHTMLForWord(description)}</div>
                ${techTags ? `<div class="tech-tags"><strong>Í∏∞Ïà† Ïä§ÌÉù:</strong><br>${techTags}</div>` : ''}
            </div>
        `;
    }

    /**
     * Ïä§ÌÇ¨ ÏÑπÏÖò Ìè¨Îß∑
     * @param {Object} section - ÏÑπÏÖò Îç∞Ïù¥ÌÑ∞
     * @returns {string} Ìè¨Îß∑Îêú HTML
     */
    formatSkillsSection(section) {
        if (!section.categories) return '';

        return section.categories.map(category => {
            const skills = category.skills.map(skill => 
                `<li>${skill.name} (${skill.level}%)</li>`
            ).join('');

            return `
                <div style="margin-bottom: 20px;">
                    <h4>${category.title}</h4>
                    <ul>${skills}</ul>
                </div>
            `;
        }).join('');
    }

    /**
     * ÏΩîÎìú ÏÑπÏÖò Ìè¨Îß∑
     * @param {Object} section - ÏÑπÏÖò Îç∞Ïù¥ÌÑ∞
     * @returns {string} Ìè¨Îß∑Îêú HTML
     */
    formatCodeSection(section) {
        return `<div class="code-snippet">${this.cleanHTMLForWord(section.content)}</div>`;
    }

    /**
     * HTMLÏùÑ WordÏö©ÏúºÎ°ú Ï†ïÎ¶¨
     * @param {string} html - ÏõêÎ≥∏ HTML
     * @returns {string} Ï†ïÎ¶¨Îêú HTML
     */
    cleanHTMLForWord(html) {
        if (!html) return '';
        
        return html
            // Ïù¥Î™®ÏßÄÎ•º ÌÖçÏä§Ìä∏Î°ú Î≥ÄÌôò
            .replace(/üèóÔ∏è/g, '[Í±¥Ï∂ï]')
            .replace(/üéØ/g, '[ÌÉÄÍ≤ü]')
            .replace(/‚ö°/g, '[Î≤àÍ∞ú]')
            .replace(/üéÆ/g, '[Í≤åÏûÑ]')
            .replace(/üì±/g, '[Î™®Î∞îÏùº]')
            .replace(/üë•/g, '[ÌåÄ]')
            .replace(/‚è∞/g, '[ÏãúÍ∞Ñ]')
            .replace(/üìà/g, '[ÏÑ±Ïû•]')
            .replace(/üß±/g, '[Î∏îÎ°ù]')
            .replace(/‚öîÔ∏è/g, '[Í≤Ä]')
            .replace(/üöÄ/g, '[Î°úÏºì]')
            .replace(/üéì/g, '[Ï°∏ÏóÖÎ™®]')
            .replace(/üìú/g, '[Ïù∏Ï¶ùÏÑú]')
            .replace(/üèÜ/g, '[Ìä∏Î°úÌîº]')
            .replace(/üíª/g, '[Ïª¥Ìì®ÌÑ∞]')
            .replace(/üîß/g, '[ÎèÑÍµ¨]')
            .replace(/üìö/g, '[Ï±Ö]')
            // Î∂àÌïÑÏöîÌïú Ïä§ÌÉÄÏùº Ï†úÍ±∞
            .replace(/style="[^"]*"/g, '')
            // ÎØ∏ÎîîÏñ¥ Í∞§Îü¨Î¶¨ Ï†úÍ±∞
            .replace(/<div class="media-gallery">[\s\S]*?<\/div>/g, '')
            // Ïù¥ÎØ∏ÏßÄ Í¥ÄÎ†® Ï†úÍ±∞
            .replace(/<img[^>]*>/g, '[Ïù¥ÎØ∏ÏßÄ]')
            // ÏÑ±Îä• ÌÜµÍ≥Ñ Ï†úÍ±∞
            .replace(/<div class="performance-stats">[\s\S]*?<\/div>/g, '')
            // Í∏∞ÌÉÄ Ï†ïÎ¶¨
            .replace(/\n\s*\n/g, '\n')
            .trim();
    }

    /**
     * ÌÉÄÏù¥ÌãÄ Ï†ïÎ¶¨
     * @param {string} title - ÏõêÎ≥∏ ÌÉÄÏù¥ÌãÄ
     * @returns {string} Ï†ïÎ¶¨Îêú ÌÉÄÏù¥ÌãÄ
     */
    cleanTitle(title) {
        return title.replace(/üéÆ/g, '').replace(/‚Ä¢/g, '|').trim();
    }

    /**
     * Ïó∞ÎùΩÏ≤ò Ï†ïÎ≥¥ Word ÌòïÏãùÏúºÎ°ú Ìè¨Îß∑
     * @returns {string} Ìè¨Îß∑Îêú Ïó∞ÎùΩÏ≤ò
     */
    formatContactsForWord() {
        return this.personalInfo.contacts.map(contact => {
            const cleanValue = contact.value.replace(/üìß|üì±|üîó/g, '').trim();
            return cleanValue;
        }).join(' ‚Ä¢ ');
    }

    /**
     * Í≤ΩÎ†• ÏöîÏïΩ ÏÉùÏÑ±
     * @returns {string} Í≤ΩÎ†• ÏöîÏïΩ HTML
     */
    generateCareerSummary() {
        if (!this.personalInfo.experience) return '';

        const exp = this.personalInfo.experience;
        return `
            <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                <strong>Í≤ΩÎ†• ÏöîÏïΩ:</strong> ${exp.years}ÎÖÑ ${exp.months}Í∞úÏõî 
                (${exp.startDate} ~ ${exp.currentDate})
                ${this.personalInfo.level ? ` ‚Ä¢ ${this.personalInfo.level} Î†àÎ≤®` : ''}
            </div>
        `;
    }

    /**
     * PDFÏö© ÏΩòÌÖêÏ∏† ÏÉùÏÑ±
     * @returns {string} PDF ÏΩòÌÖêÏ∏†
     */
    generatePDFContent() {
        // Word ÏΩòÌÖêÏ∏†ÏôÄ ÎèôÏùºÌïòÏßÄÎßå PDF ÏµúÏ†ÅÌôî Ïä§ÌÉÄÏùº Ï†ÅÏö©
        const wordContent = this.generateWordContent();
        
        // PDF Ï†ÑÏö© Ïä§ÌÉÄÏùº Ï∂îÍ∞Ä
        return wordContent.replace(
            '</style>',
            `
            @page { 
                size: A4; 
                margin: 20mm; 
            }
            body { 
                font-size: 12px; 
            }
            .section { 
                page-break-inside: avoid; 
            }
            </style>`
        );
    }

    /**
     * ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Î≤ÑÌäº ÏÑ§Ï†ï
     */
    setupExportButtons() {
        // Word ÎÇ¥Î≥¥ÎÇ¥Í∏∞
        window.exportToWord = () => {
            try {
                const content = this.generateWordContent();
                const blob = new Blob([content], { type: 'application/msword' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${this.personalInfo.name}_Ïù¥Î†•ÏÑú_${new Date().toISOString().split('T')[0]}.doc`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                if (window.UIInteractions) {
                    window.UIInteractions.showNotification('Word Î¨∏ÏÑúÍ∞Ä Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§', 'success');
                }
            } catch (error) {
                console.error('Word export failed:', error);
                if (window.UIInteractions) {
                    window.UIInteractions.showNotification('Word ÎÇ¥Î≥¥ÎÇ¥Í∏∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§', 'error');
                }
            }
        };

        // PDF ÎÇ¥Î≥¥ÎÇ¥Í∏∞
        window.exportToPDF = () => {
            try {
                const content = this.generatePDFContent();
                const printWindow = window.open('', '_blank');
                printWindow.document.write(content);
                printWindow.document.close();
                
                printWindow.onload = () => {
                    printWindow.print();
                    setTimeout(() => {
                        printWindow.close();
                    }, 1000);
                };
                
                if (window.UIInteractions) {
                    window.UIInteractions.showNotification('PDF Ïù∏ÏáÑ Ï∞ΩÏù¥ Ïó¥Î†∏ÏäµÎãàÎã§', 'info');
                }
            } catch (error) {
                console.error('PDF export failed:', error);
                if (window.UIInteractions) {
                    window.UIInteractions.showNotification('PDF ÎÇ¥Î≥¥ÎÇ¥Í∏∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§', 'error');
                }
            }
        };
    }

    /**
     * ÏΩòÌÖêÏ∏† ÏÉàÎ°úÍ≥†Ïπ®
     */
    async refreshContent() {
        await this.loadContentData();
        console.log('üìÑ Content refreshed');
    }

    /**
     * ÏÑπÏÖò Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
     * @returns {Array} ÏÑπÏÖò Î∞∞Ïó¥
     */
    getSections() {
        return this.sections;
    }

    /**
     * Í∞úÏù∏ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
     * @returns {Object} Í∞úÏù∏ Ï†ïÎ≥¥
     */
    getPersonalInfo() {
        return this.personalInfo;
    }
}

// Ï†ÑÏó≠ Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ±
window.ContentGenerator = new ContentGenerator();

// Ï†ÑÏó≠ Ìï®ÏàòÎ°ú ÎÖ∏Ï∂ú (Í∏∞Ï°¥ ÏΩîÎìú Ìò∏ÌôòÏÑ±ÏùÄ ContentGeneratorÏóêÏÑú Ï≤òÎ¶¨)
console.log('üìù Content Generator loaded successfully!');